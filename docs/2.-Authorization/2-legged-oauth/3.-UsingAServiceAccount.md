# Using a service account

These directions assume you have already [created a service account](2.-CreatingAServiceAccount.md)

## Obtaining an Access Token using client credentials

### Building a client assertion

*Note:* many languages provide libraries which abstract over some of the following steps. You may be able to skip certain steps depending on the library you use. This guide will cover the process at a relatively low level.

The assertion we'll use to prove our identity to Vendasta's token endpoint is a [JWT](https://jwt.io/introduction/).

A JWT consists of a _header_ section, a _payload_ section and a _signature_ section.

#### Building the assertion header

The header of your assertion must contain both the algorithm (`alg`) with which the JWT is signed, and the id of the private key used to sign it (`kid`).

Both of these values may be found within the service account credential JSON file you downloaded in a previous step. Here's an example JWT header prior to encoding:

```json
{
  "alg": "RS256",
  "kid": "c0273fce-79b7-4104-8a8c-ea489abb3979"
}
```

Here's where to find each piece:

<dl>
  <dt>`alg`</dt>
  <dd>Use the value found at the `alg` key in your downloaded JSON file's `assertionHeaderData`.</dd>
  <dt>`kid`</dt>
  <dd>Use the value found at the `kid` key in your downloaded JSON file's `assertionHeaderData`.</dd>
</dl>

#### Building the assertion payload

Now we must build the assertion's payload. Here's an example payload prior to encoding.

```json
{
  "aud": "https://iam-prod.apigateway.co",
  "iat": 1591287394,
  "exp": 1591287994,
  "iss": "automated-account-creation@partner-service-account.apigateway.co",
  "sub": "automated-account-creation@partner-service-account.apigateway.co",
  "scope": "profile email"
}
```

Here's where to find each piece:

<dl>
  <dt>`aud` (i.e. audience) </dt>
  <dd>Use the value found at the `aud` key in your downloaded JSON file's `assertionPayloadData`.</dd>
  <dt>`iat` (i.e. issued at)</dt>
  <dd>The time the jwt was issued as the number of **seconds** 
  since the [Unix Epoch](https://en.wikipedia.org/wiki/Unix_time). Most languages include helpers for calculating this.</dd>
  <dt>`exp` (i.e. expiry)</dt>
  <dd>The time when the token should expire as the number of **seconds** 
  since the [Unix Epoch](https://en.wikipedia.org/wiki/Unix_time). 
  We recommend a value of 10 minutes (or less) from when the token was issued.</dd>
  <dt>`iss` (i.e. issuer)</dt>
  <dd>Use the value found at the `iss` key in your downloaded JSON file's `assertionPayloadData`.</dd>
  <dt>`sub` (i.e. subject)</dt>
  <dd>Use the value found at the `sub` key in your downloaded JSON file's `assertionPayloadData`.</dd>
  <dt>`scope`</dt>
  <dd>Space-separated [scopes](https://tools.ietf.org/html/rfc6749#section-3.3) which should be included on the access token which will be issued.</dd>
</dl>

**Note:** The `jti` claim, which is a client-provided unique identifier for the JWT (typically a UUID) is not yet supported by Vendasta. It will be ignored if provided.

After constructing a JSON object representing your claims, you'll need to sign it with your private key.

#### Signing the client assertion

The steps required to sign your JWT will vary substantially depending on which 
language you are working with. Please consult a trusted JWT library in the language of your choice.

Ensure you provide the appropriate headers, use the correct signing algorithm (as specified in your downloaded JSON file) and provide your payload as the JWT's claims. 

The encoded and signed JWT you receive as a result of this process will then be used as your client **assertion** in the next step.

### Exchanging your client assertion for an access token

Now that we have a signed client assertion we can provide it to Vendasta's **token URL** to receive an **access token**.

We need to provide this assertion as a parameter to the **token URL**.

Use your language's provided library to encode the following key-value pairs as form data and set your `Content-Type` header to `application/x-www-form-urlencoded`.

* `grant_type=urn:ietf:params:oauth:grant-type:jwt-bearer`
* `assertion=<client-assertion>` (use the client assertion you built in the previous step)

Construct a `POST` request to URI provided in the `token_uri` field of your downloaded JSON file with the encoded form-data as the body.

Here's an example `curl` command:

```sh
curl --location --request POST 'https://sso-api-prod.apigateway.co/oauth2/token' \
--header 'Content-Type: application/x-www-form-urlencoded' \
--data-urlencode 'grant_type=urn:ietf:params:oauth:grant-type:jwt-bearer' \
--data-urlencode 'assertion=<your-assertion>'
```

### Example

Configuring your OAuth2 library will vary, however here is an example **golang** implementation which obtains an access token and uses it to call Vendasta's UserInfo endpoint.

**Note:** these examples assumes you've included your client credential key pair in the current working directory at the path: `./client-credentials.json`.

```go
package main

import (
	"context"
	"encoding/json"
	"fmt"
	"io/ioutil"
	"log"
	"net/http"
	"strings"
	"time"

	"golang.org/x/oauth2/jwt"
)

type credentials struct {
	Type         string `json:"type"`
	PrivateKeyID string `json:"private_key_id"`
	PrivateKey   string `json:"private_key"`
	ClientEmail  string `json:"client_email"`
	TokenURI     string `json:"token_uri"`
}

func main() {
	// Read in the downloaded Credential JSON
	bytes, err := ioutil.ReadFile("./client-credentials.json")
	if err != nil {
		log.Fatal(err)
		return
	}

	// Parse the JSON credential to access its fields
	var creds credentials
	err = json.Unmarshal(bytes, &creds)
	if err != nil {
		log.Fatal(err)
		return
	}

	// Construct the configuration required by the "golang.org/x/oauth2/jwt" library
	oauthConfig := jwt.Config{
		// The email address of our service account
		Email: creds.ClientEmail,
		// The private key we created
		PrivateKey: []byte(creds.PrivateKey),
		// The ID of the private key we created
		PrivateKeyID: creds.PrivateKeyID,
		// The JWT's subject is the service account's email
		Subject: creds.ClientEmail,
		// A list of scopes which the Access Token will have access to.
		// We'll request the 'profile' and 'email' scopes
		Scopes: []string{"profile", "email"},
		// The provided token URL
		TokenURL: creds.TokenURI,
		// Expire the Access Token in 10 minutes
		Expires: 10 * time.Minute,
		// The audience of the JWT
		Audience: "https://iam-prod.apigateway.co",
		// We don't need to provide any private claims
		PrivateClaims: nil,
		// We need an Access Token, not an ID Token
		UseIDToken: false,
	}

	// Fetch a token from Vendasta using a client assertion
	ctx := context.Background()
	tokenInfo, err := oauthConfig.TokenSource(ctx).Token()
	if err != nil {
		log.Fatal(err)
		return
	}

	// Create a Test Request to Vendasta's UserInfo endpoint
	body := strings.NewReader("")
	req, err := http.NewRequest("GET", "https://sso-api-prod.apigateway.co/oauth2/user-info", body)
	if err != nil {
		log.Fatal(err)
		return
	}

	// Attach our access token using the Authorization header.
	req.Header.Add("Authorization", fmt.Sprintf("Bearer %s", tokenInfo.AccessToken))

	// Perform the request
	resp, err := http.DefaultClient.Do(req)
	if err != nil {
		log.Fatal(err)
		return
	}

	// Receive and print out the response
	respBytes, err := ioutil.ReadAll(resp.Body)
	if err != nil {
		log.Fatal(err)
		return
	}

	fmt.Println(string(respBytes))
}
```

## Calling APIs using an Access Token

After obtaining an Access Token you may now use this token to call Vendasta APIs.

Vendasta APIs expect an Access Token provided as a **Bearer Token** in the `Authorization` HTTP header. E.g. you would provide the HTTP Header `Authorization: Bearer <access_token>` with your request.

If you obtained an access token during the previous step of this guide you can test it by calling Vendasta's User Info endpoint with the following curl command. Replace `<access_token>` with your access token.


**NOTE:** the following call requires that you attached either the `profile` or `email` scope when requesting an access token in the previous step.

```sh
curl --location --request GET 'https://sso-api-prod.apigateway.co/oauth2/user-info' \
--header 'Authorization: Bearer <access_token>'
```

If successful, you should receive a response similar to the following. Fields may differ according to which scopes the token has access to.

```json
{
  "sub": "U-d6f69389-350c-465e-ad8a-3c68447fb63a",
  "email": "automated-account-creation@partner-service-account.apigateway.co",
  "updated_at": 1591049766,
  "roles": [
    "partner_service_account"
  ],
  "created_at": 1591049766
}
```
